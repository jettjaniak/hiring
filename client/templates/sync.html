{% extends "base.html" %}

{% block title %}Sync Console - Hiring Process Management{% endblock %}

{% block content %}
<style>
    .sync-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #007bff;
    }

    .sync-status {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .sync-status h3 {
        margin-top: 0;
        color: #333;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
        border-bottom: none;
    }

    .status-label {
        font-weight: bold;
        color: #555;
    }

    .status-value {
        color: #333;
    }

    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: bold;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #333;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .sync-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .btn-sync {
        flex: 1;
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-push {
        background-color: #17a2b8;
        color: white;
    }

    .btn-push:hover:not(:disabled) {
        background-color: #138496;
    }

    .btn-pull {
        background-color: #28a745;
        color: white;
    }

    .btn-pull:hover:not(:disabled) {
        background-color: #218838;
    }

    .btn-full {
        background-color: #007bff;
        color: white;
    }

    .btn-full:hover:not(:disabled) {
        background-color: #0056b3;
    }

    .btn-sync:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .console-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
        border-radius: 5px;
        padding: 15px;
        font-family: 'Courier New', Consolas, monospace;
        font-size: 14px;
        line-height: 1.6;
        max-height: 500px;
        overflow-y: auto;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
    }

    .console-line {
        margin: 2px 0;
        word-wrap: break-word;
    }

    .console-empty {
        color: #808080;
        font-style: italic;
    }

    .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .clear-console {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }

    .clear-console:hover {
        background-color: #545b62;
    }
</style>

<div class="sync-header">
    <h2>üîÑ Sync Console</h2>
</div>

<div class="sync-status">
    <h3>Sync Status</h3>
    <div class="status-item">
        <span class="status-label">Last Sync:</span>
        <span class="status-value">{{ last_sync }}</span>
    </div>
    <div class="status-item">
        <span class="status-label">Unpushed Local Candidates:</span>
        <span class="status-value">
            {% if unsynced_candidates > 0 %}
                <span class="badge badge-warning">{{ unsynced_candidates }}</span>
            {% else %}
                <span class="badge badge-success">0</span>
            {% endif %}
        </span>
    </div>
    <div class="status-item">
        <span class="status-label">Unpushed Local Tasks:</span>
        <span class="status-value">
            {% if unsynced_tasks > 0 %}
                <span class="badge badge-warning">{{ unsynced_tasks }}</span>
            {% else %}
                <span class="badge badge-success">0</span>
            {% endif %}
        </span>
    </div>
</div>

<div class="sync-controls">
    <button class="btn-sync btn-push" id="btn-push">
        <span>üì§</span>
        <span>Push Local Changes</span>
    </button>
    <button class="btn-sync btn-pull" id="btn-pull">
        <span>üì•</span>
        <span>Pull Recent Changes</span>
    </button>
    <button class="btn-sync btn-full" id="btn-full">
        <span>üîÑ</span>
        <span>Full Sync (Push + Pull)</span>
    </button>
</div>

<div class="sync-controls">
    <button class="btn-sync btn-danger" id="btn-reset" style="background-color: #dc3545;">
        <span>‚ò¢Ô∏è</span>
        <span>NUCLEAR RESET (Delete All & Re-download)</span>
    </button>
    <button class="btn-sync btn-secondary" id="btn-refresh" style="background-color: #6c757d;">
        <span>üîÑ</span>
        <span>Refresh Status</span>
    </button>
</div>

<div class="console-container" id="console">
    <div class="console-line console-empty">Console output will appear here...</div>
</div>

<button class="clear-console" id="btn-clear">Clear Console</button>

<script>
    const consoleDiv = document.getElementById('console');
    const btnPush = document.getElementById('btn-push');
    const btnPull = document.getElementById('btn-pull');
    const btnFull = document.getElementById('btn-full');
    const btnReset = document.getElementById('btn-reset');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnClear = document.getElementById('btn-clear');

    function addLog(message) {
        const line = document.createElement('div');
        line.className = 'console-line';
        line.textContent = message;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function clearConsole() {
        consoleDiv.innerHTML = '<div class="console-line console-empty">Console cleared...</div>';
    }

    function disableButtons() {
        btnPush.disabled = true;
        btnPull.disabled = true;
        btnFull.disabled = true;
        btnReset.disabled = true;
        btnRefresh.disabled = true;
    }

    function enableButtons() {
        btnPush.disabled = false;
        btnPull.disabled = false;
        btnFull.disabled = false;
        btnReset.disabled = false;
        btnRefresh.disabled = false;
    }

    async function performSync(action) {
        disableButtons();

        // Clear console before starting
        consoleDiv.innerHTML = '';

        // Add spinner
        const spinnerLine = document.createElement('div');
        spinnerLine.className = 'console-line';
        spinnerLine.innerHTML = '<span class="spinner"></span> Working...';
        consoleDiv.appendChild(spinnerLine);

        try {
            const response = await fetch(`/api/sync/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            // Remove spinner
            consoleDiv.innerHTML = '';

            // Add logs
            data.logs.forEach(log => addLog(log));

            // Always re-enable buttons and don't auto-reload
            enableButtons();

            if (data.success) {
                addLog('');
                addLog('üí° Click "Refresh Status" to see updated counts');
            }
        } catch (error) {
            consoleDiv.innerHTML = '';
            addLog('‚ùå Error: ' + error.message);
            enableButtons();
        }
    }

    btnPush.addEventListener('click', () => performSync('push'));
    btnPull.addEventListener('click', () => performSync('pull'));
    btnFull.addEventListener('click', () => performSync('full'));
    btnReset.addEventListener('click', () => {
        if (confirm('‚ò¢Ô∏è NUCLEAR RESET ‚ò¢Ô∏è\n\nThis will DELETE ALL LOCAL DATA and re-download from server.\n\n‚Ä¢ All candidates will be DELETED\n‚Ä¢ All tasks will be DELETED\n‚Ä¢ All unpushed changes will be LOST\n\nThis action CANNOT be undone!\n\nContinue?')) {
            performSync('reset');
        }
    });
    btnRefresh.addEventListener('click', () => window.location.reload());
    btnClear.addEventListener('click', clearConsole);
</script>

{% endblock %}
